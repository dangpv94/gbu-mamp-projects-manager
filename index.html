<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMP Projects - Local Development</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .project-list {
            list-style: none;
            padding: 0;
        }
        .project-item {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .project-item:hover {
            background: #e9ecef;
        }
        .project-link {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            font-size: 18px;
        }
        .project-link:hover {
            color: #0056b3;
        }
        .project-path {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .status {
            color: #28a745;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Folder browser styles */
        .folder-item:hover {
            background-color: #f8f9fa !important;
        }
        
        .breadcrumb-btn {
            transition: all 0.2s;
        }
        
        .breadcrumb-btn:hover {
            background-color: #007bff !important;
            color: white !important;
        }
        
        .modal-overlay {
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Local Development Projects</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            All projects are now organized within MAMP for easier management
        </p>
        
        <ul class="project-list">
            <li class="project-item">
                <div>
                    <a href="http://localhost" class="project-link">MAMP Default</a>
                    <div class="status">‚úÖ Active</div>
                    <div class="project-path">localhost (MAMP Start Page)</div>
                </div>
            </li>
        </ul>
        
        <!-- Add New Project Section -->
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 5px; border: 2px dashed #007bff;">
            <h3 style="color: #007bff; margin-top: 0; text-align: center;">‚ûï Add New Project</h3>
            <button type="button" id="addProjectBtn" onclick="toggleAddForm()" style="
                width: 100%;
                padding: 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
                margin-bottom: 15px;
            ">Add New Virtual Host</button>
            
            <div id="addProjectForm" style="display: none;">
                <form onsubmit="generateVirtualHost(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Project Name:</label>
                        <input type="text" id="projectName" required placeholder="e.g., my-awesome-project" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                        <small style="color: #666;">This will be used for the folder name and domain (project-name.local)</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Domain:</label>
                        <input type="text" id="projectDomain" placeholder="Will be auto-generated" readonly style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            background: #f8f9fa;
                            box-sizing: border-box;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Source Path (optional):</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" id="sourcePath" placeholder="Required: Enter path to existing project folder" style="
                                flex: 1;
                                padding: 8px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                box-sizing: border-box;
                            ">
                            <button type="button" onclick="browseFolder()" style="
                                padding: 8px 12px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                white-space: nowrap;
                            ">üìÅ Browse</button>
                        </div>
                        
                        <!-- Folder Browser Modal -->
                        <div id="folderBrowser" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                                <h3 style="margin-top: 0; color: #333;">üìÅ Select Project Folder</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <span style="font-weight: bold;">Current Path:</span>
                                        <code id="currentPath" style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px; flex: 1;">/Users</code>
                                        <button type="button" onclick="goToHome()" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">üè† Home</button>
                                    </div>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;" id="breadcrumb"></div>
                                </div>
                                
                                <div style="border: 1px solid #ddd; border-radius: 5px; height: 300px; overflow-y: auto; margin-bottom: 15px;" id="folderList">
                                    <div style="padding: 20px; text-align: center; color: #666;">Loading folders...</div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button type="button" onclick="selectCurrentFolder()" style="
                                        padding: 10px 20px;
                                        background: #28a745;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                    ">‚úÖ Select This Folder</button>
                                    <button type="button" onclick="closeFolderBrowser()" style="
                                        padding: 10px 20px;
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                    ">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Project Location Info -->
                        <div style="margin-bottom: 8px; padding: 12px; background: #e7f3ff; border-radius: 4px; border: 1px solid #b3d9ff;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #0066cc;">üìç Project Location:</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">üîó</span>
                                <span style="flex: 1; color: #004085;"><strong>Use Original Path</strong> - Point directly to existing project folder</span>
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: rgba(0, 102, 204, 0.1); border-radius: 3px; font-size: 12px; color: #004085;">
                                üí° Virtual host will point directly to your project folder without copying files.
                            </div>
                        </div>

                        <div id="quickPathButtons" style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px;">
                            <!-- Dynamic buttons will be populated by JavaScript -->
                        </div>
                        
                        <small style="color: #666;">If you have existing project files, enter the full path or use the Browse button</small>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="submit" style="
                            padding: 10px 20px;
                            background: #28a745;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">üöÄ Create Project Now</button>
                        <button type="button" onclick="toggleAddForm()" style="
                            padding: 10px 20px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Cancel</button>
                    </div>
                </form>
            </div>
            
            <div id="generatedConfig" style="display: none; margin-top: 20px;">
                <h4 style="color: #28a745;">‚úÖ Configuration Generated!</h4>
                <div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto;">
                    <pre id="configOutput"></pre>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                    <h5 style="color: #856404; margin-top: 0;">üöÄ Next Steps:</h5>
                    <ol style="color: #856404; margin: 0;">
                        <li>Copy the configuration above</li>
                        <li>Open <code>/Applications/MAMP/conf/apache/extra/httpd-vhosts.conf</code></li>
                        <li>Paste it before the template section</li>
                        <li>Add <code>127.0.0.1 [domain]</code> to <code>/etc/hosts</code></li>
                        <li>Restart MAMP</li>
                        <li>Refresh this page to see your new project</li>
                    </ol>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button type="button" onclick="copyConfig()" style="
                        padding: 8px 16px;
                        background: #17a2b8;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">üìã Copy Config</button>
                    <button type="button" onclick="openHostsFile()" style="
                        padding: 8px 16px;
                        background: #fd7e14;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">üìù Edit Hosts File</button>
                    <button type="button" onclick="resetForm()" style="
                        padding: 8px 16px;
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                    ">Add Another</button>
                </div>
            </div>
        </div>

        <!-- System Controls Section -->
        <div style="margin-top: 30px; padding: 20px; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #28a745;">
            <h3 style="color: #155724; margin-top: 0; display: flex; align-items: center; gap: 8px;">
                ‚öôÔ∏è System Controls
            </h3>
            <p style="color: #155724; margin-bottom: 20px;">Quick actions to manage your MAMP server and projects.</p>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <!-- Restart Apache Button -->
                <button id="restartApacheBtn" onclick="restartApache()" style="
                    padding: 12px 20px;
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(40, 167, 69, 0.3)'">
                    üîÑ Restart Apache Server
                </button>
                
                <!-- Update Project Location Button -->
                <button id="updateLocationBtn" onclick="showUpdateLocationModal()" style="
                    padding: 12px 20px;
                    background: linear-gradient(135deg, #007bff, #0056b3);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 123, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 123, 255, 0.3)'">
                    üìÇ Update Project Location
                </button>
            </div>
            
            <div style="margin-top: 15px; padding: 12px; background: rgba(21, 87, 36, 0.1); border-radius: 6px;">
                <p style="margin: 0; color: #155724; font-size: 13px;">
                    üí° <strong>Tip:</strong> Use these controls when projects aren't loading correctly or after making changes to virtual host configurations.
                </p>
            </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-radius: 5px;">
            <h3 style="color: #0066cc; margin-top: 0;">üìù Quick Notes:</h3>
            <ul style="color: #333;">
                <li>All projects are now located in <code>/Applications/MAMP/htdocs/projects/</code></li>
                <li>Virtual hosts configuration: <code>/Applications/MAMP/conf/apache/extra/httpd-vhosts.conf</code></li>
                <li>Remember to restart MAMP after making configuration changes</li>
                <li>Logs are stored in <code>/Applications/MAMP/logs/</code></li>
            </ul>
            
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                <h4 style="color: #856404; margin-top: 0; font-size: 16px;">üîß Troubleshooting</h4>
                <p style="color: #856404; margin: 8px 0; font-size: 14px;">
                    Having "This site can't be reached" errors? Check your hosts file to make sure all domains are properly set.
                </p>
                <div style="text-align: center; margin-top: 12px;">
                    <button onclick="openHostsFile()" style="
                        display: inline-block;
                        padding: 8px 16px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        text-decoration: none;
                        border-radius: 6px;
                        font-weight: 600;
                        font-size: 14px;
                        cursor: pointer;
                        transition: transform 0.2s ease;
                    " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        üìù Edit Hosts File
                    </button>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div style="margin-top: 30px; padding: 20px; background: #ffe6e6; border: 2px solid #dc3545; border-radius: 5px;">
            <h3 style="color: #dc3545; margin-top: 0; display: flex; align-items: center; gap: 8px;">
                ‚ö†Ô∏è Danger Zone
            </h3>
            <p style="color: #721c24; margin-bottom: 20px; font-size: 14px;">
                <strong>Warning:</strong> These actions are permanent and cannot be undone. Use with extreme caution!
            </p>
            <button type="button" id="removeAllBtn" onclick="confirmRemoveAll()" style="
                padding: 12px 24px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 0 auto;
            " onmouseover="this.style.backgroundColor='#c82333'; this.style.transform='scale(1.02)'" onmouseout="this.style.backgroundColor='#dc3545'; this.style.transform='scale(1)'">
                üóëÔ∏è Remove All Projects
            </button>
            <div style="margin-top: 15px; padding: 12px; background: rgba(220, 53, 69, 0.1); border-radius: 4px;">
                <p style="color: #721c24; font-size: 12px; margin: 0; text-align: center;">
                    üí° <strong>This will:</strong> Remove all virtual hosts, delete hosts entries, and remove project folders from MAMP
                </p>
            </div>
        </div>
        
        <!-- Update Project Location Modal -->
        <div id="updateLocationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                <h3 style="margin-top: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                    üìÇ Update Project Location
                </h3>
                
                <p style="color: #666; margin-bottom: 20px;">
                    Select a project to update its document root location. This will modify the virtual host configuration to point to a new directory.
                </p>
                
                <div id="updateProjectSelection" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Select Project:</label>
                    <select id="projectSelect" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-size: 14px;
                        box-sizing: border-box;
                    ">
                        <option value="">Loading projects...</option>
                    </select>
                </div>
                
                <div id="currentLocationInfo" style="display: none; margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
                    <h5 style="margin: 0 0 8px 0; color: #007bff;">üìÅ Current Location:</h5>
                    <code id="currentLocationPath" style="background: #e9ecef; padding: 4px 8px; border-radius: 4px;"></code>
                </div>
                
                <div id="newLocationSection" style="display: none;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">New Project Location:</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input type="text" id="newLocationPath" placeholder="Enter new path or browse..." style="
                            flex: 1;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                        <button type="button" id="browseNewLocationBtn" style="
                            padding: 10px 15px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            white-space: nowrap;
                        ">üìÅ Browse</button>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <p style="margin: 0; color: #856404; font-size: 14px;">
                            ‚ö†Ô∏è <strong>Important:</strong> Make sure the new location contains your project files. This will update the Apache virtual host configuration and restart the server.
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" id="applyLocationUpdateBtn" onclick="applyLocationUpdate()" disabled style="
                        padding: 12px 20px;
                        background: #28a745;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: bold;
                    ">üîÑ Apply Update</button>
                    <button type="button" onclick="closeUpdateLocationModal()" style="
                        padding: 12px 20px;
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: bold;
                    ">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle add project form
        function toggleAddForm() {
            const form = document.getElementById('addProjectForm');
            const btn = document.getElementById('addProjectBtn');
            const config = document.getElementById('generatedConfig');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.textContent = 'Cancel';
                btn.style.background = '#dc3545';
                config.style.display = 'none';
            } else {
                form.style.display = 'none';
                btn.textContent = 'Add New Virtual Host';
                btn.style.background = '#007bff';
            }
        }
        
        // Get current user home directory from browser
        function getCurrentUserHome() {
            // Try to get from PHP session or API first
            return fetch('api.php?action=get_user_info')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.home) {
                        return data.data.home;
                    }
                    // Fallback to common macOS pattern
                    return '/Users/' + (data.data.username || 'user');
                })
                .catch(() => {
                    // Final fallback - try to detect from common pattern
                    return '/Users/' + (navigator.userAgent.includes('Mac') ? 'user' : 'user');
                });
        }
        
        // Create dynamic quick access buttons
        function createQuickAccessButtons(userHome) {
            const buttonContainer = document.getElementById('quickPathButtons');
            if (!buttonContainer) return;
            
            const commonPaths = [
                { label: 'üíº Works', path: userHome + '/Works' },
                { label: 'üñ•Ô∏è Desktop', path: userHome + '/Desktop' },
                { label: 'üìÑ Documents', path: userHome + '/Documents' },
                { label: 'üì• Downloads', path: userHome + '/Downloads' },
                { label: 'üåê MAMP', path: '/Applications/MAMP/htdocs' }
            ];
            
            let buttonsHtml = '';
            commonPaths.forEach(item => {
                buttonsHtml += `
                    <button type="button" onclick="setCommonPath('${item.path}')" style="
                        padding: 4px 8px;
                        background: #e7f3ff;
                        color: #0066cc;
                        border: 1px solid #b3d9ff;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 12px;
                    ">${item.label}</button>
                `;
            });
            
            buttonContainer.innerHTML = buttonsHtml;
        }
        
        // Create dynamic quick access buttons for Update Location Modal
        function createUpdateLocationQuickAccessButtons(userHome) {
            const buttonContainer = document.getElementById('updateLocationQuickButtons');
            if (!buttonContainer) return;
            
            const commonPaths = [
                { label: 'üíº Works', path: userHome + '/Works' },
                { label: 'üñ•Ô∏è Desktop', path: userHome + '/Desktop' },
                { label: 'üìÑ Documents', path: userHome + '/Documents' },
                { label: 'üì• Downloads', path: userHome + '/Downloads' },
                { label: 'üåê MAMP', path: '/Applications/MAMP/htdocs' }
            ];
            
            let buttonsHtml = '';
            commonPaths.forEach(item => {
                buttonsHtml += `
                    <button type="button" onclick="setNewLocationPath('${item.path}')" style="
                        padding: 4px 8px;
                        background: #e7f3ff;
                        color: #0066cc;
                        border: 1px solid #b3d9ff;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 12px;
                    ">${item.label}</button>
                `;
            });
            
            buttonContainer.innerHTML = buttonsHtml;
        }
        
        // Initialize event listeners when DOM is ready
        function initializeEventListeners() {
            // Auto-generate domain when project name changes
            const projectNameInput = document.getElementById('projectName');
            if (projectNameInput) {
                projectNameInput.addEventListener('input', function(e) {
                    const projectName = e.target.value.toLowerCase()
                        .replace(/[^a-z0-9-]/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    
                    const domainInput = document.getElementById('projectDomain');
                    if (domainInput) {
                        domainInput.value = projectName ? projectName + '.local' : '';
                    }
                });
            }
            
            // Initialize dynamic quick access buttons
            getCurrentUserHome().then(userHome => {
                createQuickAccessButtons(userHome);
                createUpdateLocationQuickAccessButtons(userHome);
                // Set initial browser path to user home
                currentBrowsePath = userHome;
                userHomeDirectory = userHome;
            }).catch(error => {
                console.warn('Could not detect user home, using fallback paths:', error);
                // Fallback to generic paths
                createQuickAccessButtons('/Users/user');
                createUpdateLocationQuickAccessButtons('/Users/user');
                currentBrowsePath = '/Users/user';
                userHomeDirectory = '/Users/user';
            });
        }
        // Show success message with setup information
        function showSuccessMessage(message, data) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: bold;
                max-width: 90%;
            `;
            
            let html = `<div style="margin-bottom: 10px;">‚úÖ ${message}</div>`;
            
            if (data && data.project) {
                if (data.setupCompleted) {
                    html += `<div style="font-size: 14px; opacity: 0.9;">üöÄ Visit: <a href="${data.project.url}" target="_blank" style="color: #fff; text-decoration: underline;">${data.project.url}</a></div>`;
                } else {
                    html += `<div style="font-size: 14px; opacity: 0.9;">‚ö†Ô∏è Manual setup required</div>`;
                    if (data.setupOutput && data.setupOutput.includes('mamp-sudoers-setup.sh')) {
                        html += `<div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">üí° Run ./mamp-sudoers-setup.sh for automatic setup</div>`;
                    }
                }
            }
            
            successDiv.innerHTML = html;
            document.body.appendChild(successDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 5000);
        }
        
        // Show setup instructions for sudoers configuration
        function showSetupInstructions(data) {
            const instructionsDiv = document.createElement('div');
            instructionsDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 1001;
                max-width: 600px;
                border: 2px solid #ffc107;
            `;
            
            let html = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 24px; margin-right: 10px;">‚öôÔ∏è</span>
                    <h3 style="margin: 0; color: #333;">Setup Required</h3>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; color: #856404;"><strong>Good news:</strong> Your project was created successfully!</p>
                    <p style="margin: 8px 0 0 0; color: #856404;">However, automatic setup requires system permissions.</p>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4 style="color: #333; margin-bottom: 10px;">üöÄ Enable Automatic Setup (Recommended)</h4>
                    <p style="color: #666; margin-bottom: 10px;">Run this command once to enable passwordless project creation:</p>
                    <div style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; position: relative;">
                        ./mamp-sudoers-setup.sh
                        <button onclick="copyToClipboard('./mamp-sudoers-setup.sh')" style="
                            position: absolute;
                            right: 8px;
                            top: 8px;
                            background: #4a5568;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 4px 8px;
                            cursor: pointer;
                            font-size: 12px;
                        ">Copy</button>
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4 style="color: #333; margin-bottom: 10px;">üîß Manual Setup (This Time Only)</h4>
                    <p style="color: #666; margin-bottom: 10px;">Or complete this project setup manually:</p>
                    <div style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; position: relative;">
                        ./setup-project.sh ${data.project ? data.project.domain : ''}
                        <button onclick="copyToClipboard('./setup-project.sh ${data.project ? data.project.domain : ''}')" style="
                            position: absolute;
                            right: 8px;
                            top: 8px;
                            background: #4a5568;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 4px 8px;
                            cursor: pointer;
                            font-size: 12px;
                        ">Copy</button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        padding: 10px 20px;
                        cursor: pointer;
                        font-weight: bold;
                    ">Got it!</button>
                </div>
            `;
            
            instructionsDiv.innerHTML = html;
            document.body.appendChild(instructionsDiv);
        }
        
        // Copy text to clipboard
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // Show temporary feedback
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#4a5568';
                    }, 1500);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.style.background = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4a5568';
                }, 1500);
            }
        }
        
        // Generate virtual host configuration and create project
        function generateVirtualHost(event) {
            event.preventDefault();
            
            const projectName = document.getElementById('projectName').value.trim();
            const domain = document.getElementById('projectDomain').value.trim();
            const sourcePath = document.getElementById('sourcePath').value.trim();
            const locationType = 'link'; // Always use original path
            
            if (!projectName || !domain) {
                alert('Please enter a project name');
                return;
            }
            
            // Source path is required
            if (!sourcePath) {
                alert('Please select the source path for your existing project.');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('addProjectBtn');
            const originalBtnText = btn.textContent;
            const originalBtnColor = btn.style.background;
            
            btn.textContent = 'Creating Project...';
            btn.style.background = '#ffc107';
            btn.disabled = true;
            
            // Prepare data for API
            const projectData = {
                action: 'create_project',
                projectName: projectName,
                domain: domain,
                sourcePath: sourcePath,
                locationType: locationType
            };
            
            // Call API to create project
            fetch('api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(projectData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showSuccessMessage(data.message, data.data);
                    
                    // Reset form
                    document.getElementById('addProjectForm').style.display = 'none';
                    btn.textContent = 'Project Created Successfully!';
                    btn.style.background = '#28a745';
                    
                    // Refresh project list
                    loadProjects();
                    
                    // Auto-reset after 3 seconds
                    setTimeout(() => {
                        resetForm();
                    }, 3000);
                    
                } else {
                    // Check if this requires setup
                    if (data.data && data.data.setup_instructions) {
                        showSetupInstructions(data.data);
                        
                        // Update button to reflect partial success
                        btn.textContent = 'Project Created - Setup Required';
                        btn.style.background = '#ffc107';
                        btn.disabled = false;
                        
                        // Refresh project list anyway since project was created
                        loadProjects();
                        
                        // Auto-reset after 5 seconds
                        setTimeout(() => {
                            btn.textContent = originalBtnText;
                            btn.style.background = originalBtnColor;
                        }, 5000);
                    } else {
                        // Show regular error message
                        alert('Error: ' + data.message);
                        
                        // Reset button
                        btn.textContent = originalBtnText;
                        btn.style.background = originalBtnColor;
                        btn.disabled = false;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error: Could not create project. Please try again.');
                
                // Reset button
                btn.textContent = originalBtnText;
                btn.style.background = originalBtnColor;
                btn.disabled = false;
            });
        }
        
        // Create project folder instructions
        function createProjectFolder(folderName) {
            const instructions = document.createElement('div');
            instructions.style.marginTop = '15px';
            instructions.style.padding = '15px';
            instructions.style.background = '#d1ecf1';
            instructions.style.border = '1px solid #bee5eb';
            instructions.style.borderRadius = '5px';
            instructions.innerHTML = `
                <h5 style="color: #0c5460; margin-top: 0;">üìÅ Create Project Folder:</h5>
                <p style="color: #0c5460; margin: 0;">Run this command in Terminal to create the project folder:</p>
                <code style="background: #2d3748; color: #e2e8f0; padding: 8px; display: block; margin: 10px 0; border-radius: 4px;">mkdir -p "/Applications/MAMP/htdocs/projects/${folderName}"</code>
                <button onclick="copyCommand('mkdir -p "/Applications/MAMP/htdocs/projects/${folderName}"')" style="
                    padding: 6px 12px;
                    background: #17a2b8;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Copy Command</button>
            `;
            document.getElementById('generatedConfig').appendChild(instructions);
        }
        
        // Show copy instructions for existing project
        function showCopyInstructions(sourcePath, folderName) {
            const instructions = document.createElement('div');
            instructions.style.marginTop = '15px';
            instructions.style.padding = '15px';
            instructions.style.background = '#d1ecf1';
            instructions.style.border = '1px solid #bee5eb';
            instructions.style.borderRadius = '5px';
            instructions.innerHTML = `
                <h5 style="color: #0c5460; margin-top: 0;">üìÅ Copy Existing Project:</h5>
                <p style="color: #0c5460; margin: 0;">Run this command in Terminal to copy your existing project:</p>
                <code style="background: #2d3748; color: #e2e8f0; padding: 8px; display: block; margin: 10px 0; border-radius: 4px;">cp -R "${sourcePath}" "/Applications/MAMP/htdocs/projects/${folderName}"</code>
                <button onclick="copyCommand('cp -R "${sourcePath}" "/Applications/MAMP/htdocs/projects/${folderName}"')" style="
                    padding: 6px 12px;
                    background: #17a2b8;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Copy Command</button>
            `;
            document.getElementById('generatedConfig').appendChild(instructions);
        }
        
        // Show instructions for linking to original path
        function showLinkInstructions(sourcePath, projectName) {
            const instructions = document.createElement('div');
            instructions.style.marginTop = '15px';
            instructions.style.padding = '15px';
            instructions.style.background = '#fff3cd';
            instructions.style.border = '1px solid #ffeaa7';
            instructions.style.borderRadius = '5px';
            instructions.innerHTML = `
                <h5 style="color: #856404; margin-top: 0;">üîó Using Original Path:</h5>
                <p style="color: #856404; margin: 0;">Virtual host will point directly to your existing project:</p>
                <div style="background: #2d3748; color: #e2e8f0; padding: 8px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px;">
                    üìÅ Project Location: <strong>${sourcePath}</strong>
                </div>
                <div style="background: #e7f3ff; padding: 8px; border-radius: 4px; margin: 10px 0;">
                    <p style="margin: 0; color: #0066cc; font-size: 12px;">
                        ‚úÖ <strong>Benefits:</strong> No disk space duplication, changes reflect immediately<br>
                        ‚ö†Ô∏è <strong>Note:</strong> Make sure the path exists and has proper permissions
                    </p>
                </div>
            `;
            document.getElementById('generatedConfig').appendChild(instructions);
        }
        
        // Copy configuration to clipboard
        function copyConfig() {
            if (window.generatedConfigText) {
                navigator.clipboard.writeText(window.generatedConfigText)
                    .then(() => {
                        alert('Configuration copied to clipboard!');
                    })
                    .catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = window.generatedConfigText;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('Configuration copied to clipboard!');
                    });
            }
        }
        
        // Copy command to clipboard
        function copyCommand(command) {
            navigator.clipboard.writeText(command)
                .then(() => {
                    alert('Command copied to clipboard!');
                })
                .catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = command;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Command copied to clipboard!');
                });
        }
        
        // Open hosts file helper
        function openHostsFile() {
            const instructions = `To edit the hosts file:

1. Open Terminal
2. Run: sudo nano /etc/hosts
3. Add a new line: 127.0.0.1 [your-domain.local]
4. Press Ctrl+X, then Y, then Enter to save

Command to copy:
sudo nano /etc/hosts`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText('sudo nano /etc/hosts').then(() => {
                    alert('‚úÖ Command copied to clipboard!\n\n' + instructions);
                }).catch(() => {
                    alert(instructions);
                });
            } else {
                alert(instructions);
            }
        }
        
        // Reset form for adding another project
        function resetForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('projectDomain').value = '';
            document.getElementById('sourcePath').value = '';
            document.getElementById('generatedConfig').style.display = 'none';
            document.getElementById('addProjectForm').style.display = 'block';
            
            const btn = document.getElementById('addProjectBtn');
            btn.textContent = 'Add New Virtual Host';
            btn.style.background = '#007bff';
            btn.disabled = false;
            
            // Remove any additional instructions
            const config = document.getElementById('generatedConfig');
            const additionalDivs = config.querySelectorAll('div:not(:first-child):not(:nth-child(2)):not(:nth-child(3))');
            additionalDivs.forEach(div => div.remove());
        }
        
        // Folder browser functionality
        let currentBrowsePath = '/Users/user'; // Will be updated by initializeEventListeners
        let userHomeDirectory = '/Users/user'; // Store user home for goToHome function
        
        function browseFolder() {
            document.getElementById('folderBrowser').style.display = 'block';
            loadFolders(currentBrowsePath);
        }
        
        function closeFolderBrowser() {
            document.getElementById('folderBrowser').style.display = 'none';
        }
        
        function setCommonPath(path) {
            document.getElementById('sourcePath').value = path;
            // Ensure we don't accidentally trigger form submission
            const form = document.getElementById('addProjectForm');
            if (form) {
                // Reset any pending submission state
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üöÄ Create Project Now';
                    submitBtn.style.background = '#28a745';
                }
            }
        }
        
        function goToHome() {
            currentBrowsePath = userHomeDirectory;
            loadFolders(currentBrowsePath);
        }
        
        function selectCurrentFolder() {
            document.getElementById('sourcePath').value = currentBrowsePath;
            closeFolderBrowser();
        }
        
        async function loadFolders(path) {
            currentBrowsePath = path;
            document.getElementById('currentPath').textContent = path;
            updateBreadcrumb(path);
            
            const folderList = document.getElementById('folderList');
            folderList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Loading folders...</div>';
            
            try {
                // Since we can't directly access file system from browser, we'll use a PHP endpoint
                const response = await fetch('browse-folders.php?path=' + encodeURIComponent(path));
                const data = await response.json();
                
                if (data.error) {
                    folderList.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">${data.error}</div>`;
                    return;
                }
                
                let html = '';
                
                // Add parent directory link
                if (path !== '/') {
                    const parentPath = path.split('/').slice(0, -1).join('/') || '/';
                    html += `<div onclick="navigateToFolder('${parentPath}')" style="
                        padding: 10px; 
                        border-bottom: 1px solid #eee; 
                        cursor: pointer;
                        display: flex; 
                        align-items: center; 
                        gap: 8px;
                        transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'">
                        üìÅ <span style="color: #6c757d;">..</span>
                    </div>`;
                }
                
                // Add folders
                data.folders.forEach(folder => {
                    const folderPath = path === '/' ? `/${folder}` : `${path}/${folder}`;
                    html += `<div onclick="navigateToFolder('${folderPath}')" style="
                        padding: 10px; 
                        border-bottom: 1px solid #eee; 
                        cursor: pointer;
                        display: flex; 
                        align-items: center; 
                        gap: 8px;
                        transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'">
                        üìÅ <span>${folder}</span>
                    </div>`;
                });
                
                if (data.folders.length === 0 && path !== '/') {
                    html += '<div style="padding: 20px; text-align: center; color: #666; font-style: italic;">No accessible folders found</div>';
                }
                
                folderList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading folders:', error);
                folderList.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Error loading folders. Using fallback method...</div>';
                // Fallback to show common directories
                loadFallbackFolders(path);
            }
        }
        
        function loadFallbackFolders(path) {
            const folderList = document.getElementById('folderList');
            let html = '';
            
            // Dynamic common directories based on current user home
            const commonFolders = {};
            
            // Generate dynamic folder structure based on userHomeDirectory
            if (userHomeDirectory) {
                commonFolders[userHomeDirectory] = ['Works', 'Desktop', 'Documents', 'Downloads', 'Pictures'];
                commonFolders[`${userHomeDirectory}/Works`] = ['my_prj', 'rakuten_renew', 'jcom'];
                commonFolders[`${userHomeDirectory}/Works/my_prj`] = ['gbu-accessibility-tool'];
            }
            
            // Add system directories
            commonFolders['/Applications'] = ['MAMP'];
            commonFolders['/Applications/MAMP'] = ['htdocs'];
            commonFolders['/Applications/MAMP/htdocs'] = ['projects'];
            
            // Add parent directory link
            const homeDir = userHomeDirectory || '/Users';
            if (path !== homeDir) {
                const parentPath = path.split('/').slice(0, -1).join('/') || homeDir;
                html += `<div onclick="navigateToFolder('${parentPath}')" style="
                    padding: 10px; 
                    border-bottom: 1px solid #eee; 
                    cursor: pointer;
                    display: flex; 
                    align-items: center; 
                    gap: 8px;
                    transition: background-color 0.2s;
                " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'">
                    üìÅ <span style="color: #6c757d;">..</span>
                </div>`;
            }
            
            // Add folders for current path
            const folders = commonFolders[path] || [];
            folders.forEach(folder => {
                const folderPath = `${path}/${folder}`;
                html += `<div onclick="navigateToFolder('${folderPath}')" style="
                    padding: 10px; 
                    border-bottom: 1px solid #eee; 
                    cursor: pointer;
                    display: flex; 
                    align-items: center; 
                    gap: 8px;
                    transition: background-color 0.2s;
                " onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'">
                    üìÅ <span>${folder}</span>
                </div>`;
            });
            
            if (folders.length === 0) {
                html += '<div style="padding: 20px; text-align: center; color: #666; font-style: italic;">Enter path manually or use quick access buttons</div>';
            }
            
            folderList.innerHTML = html;
        }
        
        function navigateToFolder(path) {
            loadFolders(path);
        }
        
        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumb');
            const parts = path.split('/').filter(part => part !== '');
            
            let html = `<button type="button" onclick="navigateToFolder('/')" style="
                padding: 2px 6px; 
                background: #e9ecef; 
                border: 1px solid #ced4da; 
                border-radius: 3px; 
                cursor: pointer; 
                font-size: 11px;
            ">/</button>`;
            
            let currentPath = '';
            parts.forEach((part, index) => {
                currentPath += '/' + part;
                html += `<span style="margin: 0 2px; color: #6c757d;">/</span>`;
                html += `<button type="button" onclick="navigateToFolder('${currentPath}')" style="
                    padding: 2px 6px; 
                    background: #e9ecef; 
                    border: 1px solid #ced4da; 
                    border-radius: 3px; 
                    cursor: pointer; 
                    font-size: 11px;
                ">${part}</button>`;
            });
            
            breadcrumb.innerHTML = html;
        }
        
        
        // Update projects list in the UI
        function updateProjectsList(projects) {
            const projectList = document.querySelector('.project-list');
            
            // Keep localhost entry
            const localhostHtml = `
                <li class="project-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <a href="http://localhost" class="project-link">MAMP Default</a>
                            <div class="status">‚úÖ Active</div>
                            <div class="project-path">localhost (MAMP Start Page)</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="openHostsFile()" style="
                                padding: 6px 10px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                font-weight: bold;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'" title="Edit hosts file">
                                üìù Hosts
                            </button>
                        </div>
                    </div>
                </li>
            `;
            
            // Generate HTML for projects
            let projectsHtml = '';
            projects.forEach(project => {
                projectsHtml += `
                    <li class="project-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <a href="http://${project.domain}" class="project-link">${project.name}</a>
                                <div class="status">‚úÖ Active</div>
                                <div class="project-path">${project.domain}</div>
                                <div id="error-status-${project.domain.replace(/\./g, '-')}" style="margin-top: 4px;"></div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="checkProjectErrors('${project.domain}', '${project.name}')" style="
                                    padding: 6px 10px;
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 11px;
                                    font-weight: bold;
                                    transition: background-color 0.2s;
                                " onmouseover="this.style.backgroundColor='#218838'" onmouseout="this.style.backgroundColor='#28a745'" title="Check for connection issues">
                                    üîç Check
                                </button>
                                <button onclick="openHostsFile()" style="
                                    padding: 6px 10px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 11px;
                                    font-weight: bold;
                                    transition: background-color 0.2s;
                                " onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'" title="Edit hosts file">
                                    üìù Hosts
                                </button>
                                <button onclick="confirmRemoveProject('${project.domain}', '${project.name}')" style="
                                    padding: 6px 10px;
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 11px;
                                    font-weight: bold;
                                    transition: background-color 0.2s;
                                " onmouseover="this.style.backgroundColor='#c82333'" onmouseout="this.style.backgroundColor='#dc3545'" title="Remove project">
                                    üóëÔ∏è Remove
                                </button>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            projectList.innerHTML = projectsHtml + localhostHtml;
            
            // Auto-check all projects after loading
            projects.forEach(project => {
                setTimeout(() => checkProjectErrors(project.domain, project.name, true), 500);
            });
        }
        
        // Show success message
        function showSuccessMessage(message, data) {
            const successDiv = document.getElementById('generatedConfig');
            successDiv.style.display = 'block';
            successDiv.innerHTML = `
                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
                    <h3 style="margin: 0; color: white;">Project Created Successfully!</h3>
                    <p style="margin: 10px 0; opacity: 0.9;">${message}</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #495057; margin-top: 0;">üìã Project Details:</h4>
                    <div style="display: grid; gap: 10px; font-family: monospace;">
                        <div><strong>Name:</strong> ${data.project.name}</div>
                        <div><strong>Domain:</strong> <a href="${data.project.url}" target="_blank" style="color: #007bff;">${data.project.domain}</a></div>
                        <div><strong>Mode:</strong> ${data.project.mode === 'link' ? 'üîó Link (Original Path)' : 'üì¶ Copy (MAMP Folder)'}</div>
                        <div><strong>Location:</strong> ${data.project.documentRoot}</div>
                    </div>
                </div>
                
                ${data.setupCompleted ? `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5 style="color: #155724; margin-top: 0;">‚úÖ Automatic Setup Completed!</h5>
                    <p style="color: #155724; margin: 10px 0;">Great news! The setup was completed automatically. Your project is ready to use right now!</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <h6 style="color: #495057; margin: 0 0 8px 0;">‚ú® What was done automatically:</h6>
                        <ul style="color: #495057; margin: 5px 0 5px 20px; font-size: 14px;">
                            <li>‚úÖ Added hosts entry to /etc/hosts</li>
                            <li>‚úÖ Restarted MAMP Apache server</li>
                            <li>‚úÖ Verified project is accessible</li>
                        </ul>
                    </div>
                    ${data.setupOutput ? `
                    <details style="margin-top: 10px;">
                        <summary style="color: #155724; cursor: pointer; font-size: 14px;">üìã View Setup Log</summary>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 4px; font-family: monospace; margin: 8px 0; font-size: 12px; white-space: pre-wrap;">${data.setupOutput}</div>
                    </details>
                    ` : ''}
                </div>
                ` : (data.hostsWarning ? `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Setup Could Not Complete Automatically</h5>
                    <p style="color: #856404; margin: 10px 0;">The automatic setup failed. Please run the setup script manually to complete configuration:</p>
                    
                    <div style="background: #e7f3ff; border: 1px solid #b8daff; padding: 12px; border-radius: 4px; margin: 10px 0;">
                        <h6 style="color: #004085; margin: 0 0 8px 0;">üîß Run Setup Script</h6>
                        <p style="color: #004085; margin: 5px 0; font-size: 14px;">Execute this command in Terminal:</p>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 8px; border-radius: 4px; font-family: monospace; margin: 8px 0; font-size: 13px;">
                            ./setup-project.sh ${data.project.domain}
                        </div>
                        <button type="button" onclick="copyCommand('./setup-project.sh ${data.project.domain}')" style="
                            padding: 6px 12px;
                            background: #007bff;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            margin-right: 10px;
                        ">üìã Copy Script Command</button>
                    </div>
                    
                    ${data.setupOutput ? `
                    <details style="margin-top: 10px;">
                        <summary style="color: #856404; cursor: pointer; font-size: 14px;">‚ö†Ô∏è View Error Details</summary>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 4px; font-family: monospace; margin: 8px 0; font-size: 12px; white-space: pre-wrap;">${data.setupOutput}</div>
                    </details>
                    ` : ''}
                    
                    <small style="color: #856404; display: block; margin-top: 8px;">üí° You'll be prompted for your password when running sudo commands.</small>
                </div>
                ` : '')}
                
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5 style="color: #0c5460; margin-top: 0;">üöÄ Next Steps:</h5>
                    <ol style="color: #0c5460; margin: 0;">
                        <li><strong>Restart MAMP</strong> to activate the virtual host</li>
                        <li>Visit your project: <a href="${data.project.url}" target="_blank" style="color: #0c5460; font-weight: bold;">${data.project.domain}</a></li>
                        <li>Start developing in: <code>${data.project.documentRoot}</code></li>
                    </ol>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" onclick="window.open('${data.project.url}', '_blank')" style="
                        padding: 12px 24px;
                        background: #007bff;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 16px;
                        margin-right: 10px;
                    ">üöÄ Open Project</button>
                    <button type="button" onclick="resetForm()" style="
                        padding: 12px 24px;
                        background: #28a745;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 16px;
                    ">‚ûï Add Another Project</button>
                </div>
            `;
        }
        
        // Confirm and remove all projects
        function confirmRemoveAll() {
            const projects = getCurrentProjectsSync();
            
            if (projects.length === 0) {
                alert('No projects found to remove.');
                return;
            }
            
            const projectNames = projects.map(p => p.domain).join('\n‚Ä¢ ');
            const confirmMessage = `‚ö†Ô∏è WARNING: This will permanently remove ALL projects!\n\nThe following will be deleted:\n‚Ä¢ ${projectNames}\n\n‚ùå This action CANNOT be undone!\n\nType 'DELETE' to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'DELETE') {
                removeAllProjects();
            } else if (userInput !== null) {
                alert('Operation cancelled. You must type "DELETE" exactly to confirm.');
            }
        }
        
        // Get current projects synchronously for confirmation dialog
        function getCurrentProjectsSync() {
            // Use the projects already loaded in the UI
            const projectItems = document.querySelectorAll('.project-item');
            const projects = [];
            
            projectItems.forEach(item => {
                const link = item.querySelector('.project-link');
                const domain = link.href.replace('http://', '').replace('https://', '');
                
                // Skip localhost
                if (domain !== 'localhost' && domain !== 'localhost:8888') {
                    projects.push({
                        name: link.textContent,
                        domain: domain
                    });
                }
            });
            
            return projects;
        }
        
        // Remove all projects via API
        function removeAllProjects() {
            const btn = document.getElementById('removeAllBtn');
            const originalText = btn.textContent;
            const originalColor = btn.style.background;
            
            // Show loading state
            btn.textContent = 'üîÑ Removing Projects...';
            btn.style.background = '#ffc107';
            btn.disabled = true;
            
            // Call API to remove all projects
            fetch('api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'remove_all_projects'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showRemovalSuccessMessage(data.message, data.data);
                    
                    // Update button
                    btn.textContent = '‚úÖ Projects Removed Successfully!';
                    btn.style.background = '#28a745';
                    
                    // Refresh project list
                    loadProjects();
                    
                    // Auto-reset after 3 seconds
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = originalColor;
                        btn.disabled = false;
                    }, 3000);
                    
                } else {
                    // Show error message
                    alert('Error: ' + data.message);
                    
                    // Reset button
                    btn.textContent = originalText;
                    btn.style.background = originalColor;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error: Could not remove projects. Please try again.');
                
                // Reset button
                btn.textContent = originalText;
                btn.style.background = originalColor;
                btn.disabled = false;
            });
        }
        
        // Show removal success message
        function showRemovalSuccessMessage(message, data) {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            notification.style.color = 'white';
            notification.style.padding = '20px';
            notification.style.borderRadius = '10px';
            notification.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '400px';
            notification.style.fontSize = '14px';
            
            let removedProjectsHtml = '';
            if (data.removed_projects && data.removed_projects.length > 0) {
                removedProjectsHtml = '<div style="margin-top: 10px;"><strong>Removed Projects:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                data.removed_projects.forEach(project => {
                    removedProjectsHtml += `<li>${project.name} (${project.domain})</li>`;
                });
                removedProjectsHtml += '</ul></div>';
            }
            
            let errorsHtml = '';
            if (data.errors && data.errors.length > 0) {
                errorsHtml = '<div style="margin-top: 10px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px;"><strong>‚ö†Ô∏è Manual cleanup may be required:</strong><ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">';
                data.errors.forEach(error => {
                    errorsHtml += `<li>${error}</li>`;
                });
                errorsHtml += '</ul></div>';
            }
            
            notification.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 32px; margin-bottom: 10px;">üóëÔ∏è</div>
                    <strong>Projects Removed Successfully!</strong>
                </div>
                <div>${message}</div>
                ${removedProjectsHtml}
                ${errorsHtml}
                <div style="text-align: center; margin-top: 15px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; font-size: 12px;">
                        üí° <strong>Don't forget to restart MAMP</strong> to apply changes
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove notification after 8 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 8000);
            
            // Add click to close
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }
        
        // Confirm and remove individual project
        function confirmRemoveProject(domain, name) {
            const confirmMessage = `‚ö†Ô∏è WARNING: This will permanently remove the project "${name}"!\n\nThe following will be deleted:\n‚Ä¢ Virtual host configuration\n‚Ä¢ Hosts file entry (${domain})\n‚Ä¢ Project folder (if inside MAMP)\n\n‚ùå This action CANNOT be undone!\n\nType 'DELETE' to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'DELETE') {
                removeProject(domain, name);
            } else if (userInput !== null) {
                alert('Operation cancelled. You must type "DELETE" exactly to confirm.');
            }
        }
        
        // Remove individual project via API
        function removeProject(domain, name) {
            // Call API to remove the project
            fetch('api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'remove_project',
                    domain: domain
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showProjectRemovalSuccess(name, domain, data.message);
                    
                    // Refresh project list
                    loadProjects();
                    
                } else {
                    // Show error message
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error: Could not remove project. Please try again.');
            });
        }
        
        // Show project removal success message
        function showProjectRemovalSuccess(name, domain, message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            notification.style.color = 'white';
            notification.style.padding = '20px';
            notification.style.borderRadius = '10px';
            notification.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '300px';
            notification.style.fontSize = '14px';
            
            notification.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 32px; margin-bottom: 10px;">üóëÔ∏è</div>
                    <strong>Project Removed!</strong>
                </div>
                <div><strong>${name}</strong> (${domain}) has been removed successfully.</div>
                <div style="text-align: center; margin-top: 15px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; font-size: 12px;">
                        üí° <strong>Don't forget to restart MAMP</strong> to apply changes
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // Add click to close
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }
        
        // Debounce function to limit API calls
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // Cache projects data to reduce API calls
        let projectsCache = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 10000; // 10 seconds
        
        // Load projects with caching
        function loadProjectsCached() {
            const now = Date.now();
            
            // Use cache if it's still fresh
            if (projectsCache && cacheTimestamp && (now - cacheTimestamp < CACHE_DURATION)) {
                updateProjectsList(projectsCache);
                return;
            }
            
            // Fetch from API
            fetch('api.php?action=projects')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        projectsCache = data.data;
                        cacheTimestamp = now;
                        updateProjectsList(data.data);
                    }
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                    // Show fallback content
                    showOfflineMessage();
                });
        }
        
        // Show offline message when API is not available
        function showOfflineMessage() {
            const projectList = document.querySelector('.project-list');
            projectList.innerHTML = `
                <li class="project-item" style="background: #fff3cd; border-color: #ffeaa7;">
                    <div style="text-align: center; color: #856404;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div><strong>Cannot load projects</strong></div>
                        <div style="font-size: 14px; margin-top: 5px;">API may be unavailable. Try refreshing the page.</div>
                    </div>
                </li>
            `;
        }
        
        // Optimized load projects function
        const loadProjects = debounce(loadProjectsCached, 300);
        
        // Load projects on page load with faster initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            
            // Show loading state immediately
            const projectList = document.querySelector('.project-list');
            const loadingHtml = `
                <li class="project-item" style="background: #f8f9fa; border-color: #e9ecef;">
                    <div style="text-align: center; color: #6c757d;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        <div>Loading projects...</div>
                    </div>
                </li>
            `;
            projectList.innerHTML = loadingHtml;
            
            // Load projects after a short delay to improve perceived performance
            setTimeout(loadProjects, 100);
        });
        
        // Check project for errors and connectivity issues
        async function checkProjectErrors(domain, name, silent = false) {
            const statusElement = document.getElementById('error-status-' + domain.replace(/\./g, '-'));
            const domainId = domain.replace(/\./g, '-');
            
            if (!silent) {
                statusElement.innerHTML = '<small style="color: #6c757d;">üîç Checking...</small>';
            }
            
            try {
                // Try to fetch the project URL to check connectivity
                const response = await fetch(`http://${domain}`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                
                // If we get here without error, the site is likely reachable
                if (!silent) {
                    statusElement.innerHTML = '<small style="color: #28a745;">‚úÖ Connected</small>';
                }
            } catch (error) {
                // Connection failed - likely hosts file issue
                const errorMessage = 'This site can\'t be reached';
                const fixCommand = `echo '127.0.0.1    ${domain}' | sudo tee -a /etc/hosts`;
                const flushCommand = 'sudo dscacheutil -flushcache';
                
                // Create elements instead of using innerHTML to avoid escaping issues
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; border-radius: 4px; margin-top: 4px;';
                
                const errorTitle = document.createElement('div');
                errorTitle.style.cssText = 'color: #856404; font-size: 12px; font-weight: bold; margin-bottom: 4px;';
                errorTitle.innerHTML = `‚ö†Ô∏è ${errorMessage}`;
                
                const errorDesc = document.createElement('div');
                errorDesc.style.cssText = 'font-size: 11px; color: #856404; margin-bottom: 6px;';
                errorDesc.textContent = 'Domain may not be in hosts file. Run this command:';
                
                const commandDiv = document.createElement('div');
                commandDiv.style.cssText = 'background: #2d3748; color: #e2e8f0; padding: 4px 6px; border-radius: 3px; font-family: monospace; font-size: 10px; position: relative;';
                commandDiv.textContent = fixCommand;
                
                const copyBtn1 = document.createElement('button');
                copyBtn1.style.cssText = 'position: absolute; right: 2px; top: 2px; background: #4a5568; color: white; border: none; border-radius: 2px; padding: 2px 4px; cursor: pointer; font-size: 9px;';
                copyBtn1.title = 'Copy command';
                copyBtn1.innerHTML = 'üìã';
                copyBtn1.onclick = function(e) {
                    e.preventDefault();
                    copyFixCommand(fixCommand, this);
                };
                
                commandDiv.appendChild(copyBtn1);
                
                const flushDiv = document.createElement('div');
                flushDiv.style.cssText = 'margin-top: 6px; font-size: 11px; color: #856404;';
                flushDiv.innerHTML = 'Then flush DNS: <code style="font-size: 10px;">sudo dscacheutil -flushcache</code> ';
                
                const copyBtn2 = document.createElement('button');
                copyBtn2.style.cssText = 'background: #6c757d; color: white; border: none; border-radius: 2px; padding: 1px 3px; cursor: pointer; font-size: 9px; margin-left: 4px;';
                copyBtn2.title = 'Copy DNS flush command';
                copyBtn2.innerHTML = 'üìã';
                copyBtn2.onclick = function(e) {
                    e.preventDefault();
                    copyFixCommand(flushCommand, this);
                };
                
                flushDiv.appendChild(copyBtn2);
                
                errorDiv.appendChild(errorTitle);
                errorDiv.appendChild(errorDesc);
                errorDiv.appendChild(commandDiv);
                errorDiv.appendChild(flushDiv);
                
                statusElement.innerHTML = '';
                statusElement.appendChild(errorDiv);
            }
            
            // Also check if domain exists in hosts file by trying a different approach
            if (!silent) {
                setTimeout(() => {
                    checkHostsEntry(domain, statusElement);
                }, 1000);
            }
        }
        
        // Check if domain exists in hosts file
        async function checkHostsEntry(domain, statusElement) {
            try {
                // Try to resolve domain using a simple technique
                const img = new Image();
                img.onload = () => {
                    // Image loaded, domain is accessible
                    statusElement.innerHTML = '<small style="color: #28a745;">‚úÖ Connected</small>';
                };
                img.onerror = () => {
                    // Image failed to load, but this might still mean the domain resolves
                    // We'll keep the existing error message if it's already there
                    if (!statusElement.innerHTML.includes('This site can\'t be reached')) {
                        statusElement.innerHTML = '<small style="color: #ffc107;">‚ö†Ô∏è Server not responding</small>';
                    }
                };
                img.src = `http://${domain}/favicon.ico?${Date.now()}`;
                
                // Set a timeout to avoid hanging
                setTimeout(() => {
                    if (statusElement.innerHTML.includes('Checking...')) {
                        statusElement.innerHTML = '<small style="color: #dc3545;">‚ùå No response</small>';
                    }
                }, 5000);
            } catch (error) {
                console.log('Error checking hosts entry:', error);
            }
        }
        
        // Copy fix command to clipboard
        function copyFixCommand(command) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(command).then(() => {
                    // Show temporary feedback
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = button.textContent === 'üìã' ? '#4a5568' : '#6c757d';
                    }, 1500);
                    
                    // Show notification
                    showNotification('Command copied to clipboard!', 'success');
                }).catch(() => {
                    // Fallback for older browsers
                    copyCommandFallback(command);
                });
            } else {
                copyCommandFallback(command);
            }
        }
        
        // Fallback copy method
        function copyCommandFallback(command) {
            const textArea = document.createElement('textarea');
            textArea.value = command;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            showNotification('Command copied to clipboard!', 'success');
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existing = document.querySelector('.mini-notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'mini-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 10px 15px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Refresh projects when page becomes visible (tab switching optimization)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Force refresh when page becomes visible
                projectsCache = null;
                loadProjects();
            }
        });
        
        // ===== NEW FUNCTIONS FOR SYSTEM CONTROLS =====
        
        // Restart Apache Server
        async function restartApache() {
            const btn = document.getElementById('restartApacheBtn');
            const originalText = btn.textContent;
            const originalBg = btn.style.background;
            
            // Show loading state
            btn.textContent = 'üîÑ Restarting...';
            btn.style.background = '#ffc107';
            btn.disabled = true;
            
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'restart_apache'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success state
                    btn.textContent = '‚úÖ Restarted Successfully!';
                    btn.style.background = '#28a745';
                    
                    showNotification('Apache server restarted successfully!', 'success');
                    
                    // Auto-reset after 3 seconds
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = originalBg;
                        btn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error(data.message || 'Failed to restart Apache');
                }
            } catch (error) {
                console.error('Error restarting Apache:', error);
                
                // Show error state
                btn.textContent = '‚ùå Failed to Restart';
                btn.style.background = '#dc3545';
                
                showNotification('Failed to restart Apache: ' + error.message, 'error');
                
                // Show debug logs button
                showRestartDebugButton();
                
                // Reset after 5 seconds (longer to allow debug viewing)
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = originalBg;
                    btn.disabled = false;
                    
                    // Remove debug button if still present
                    const debugBtn = document.getElementById('debugLogsBtn');
                    if (debugBtn) {
                        debugBtn.remove();
                    }
                }, 5000);
            }
        }
        
        // Show debug button for Apache restart
        function showRestartDebugButton() {
            // Remove existing debug button if any
            const existingBtn = document.getElementById('debugLogsBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            const systemControls = document.querySelector('.system-controls');
            const debugBtn = document.createElement('button');
            debugBtn.id = 'debugLogsBtn';
            debugBtn.innerHTML = 'üîç View Debug Logs';
            debugBtn.style.cssText = `
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                margin-left: 10px;
            `;
            
            debugBtn.onclick = showRestartLogs;
            systemControls.appendChild(debugBtn);
        }
        
        // Show restart debug logs
        async function showRestartLogs() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'restart_logs'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.logs) {
                    const logs = data.data.logs.join('\n');
                    
                    // Create modal for logs
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 25px;
                        border-radius: 12px;
                        max-width: 90%;
                        max-height: 90%;
                        overflow: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    `;
                    
                    modalContent.innerHTML = `
                        <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">üîç Apache Restart Debug Logs</h3>
                        <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">
                            <strong>Timestamp:</strong> ${data.data.timestamp}
                        </div>
                        <pre style="
                            background: #2d3748;
                            color: #e2e8f0;
                            padding: 20px;
                            border-radius: 8px;
                            font-family: 'Monaco', 'Menlo', monospace;
                            font-size: 13px;
                            white-space: pre-wrap;
                            max-height: 500px;
                            overflow-y: auto;
                            margin: 15px 0;
                            border: 1px solid #4a5568;
                        ">${logs}</pre>
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button onclick="copyLogsToClipboard('${logs.replace(/'/g, "\\'")}')"
                                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;"
                            >üìã Copy Logs</button>
                            <button onclick="this.closest('div[style*="position: fixed"]').remove()"
                                style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;"
                            >Close</button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Close on background click
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                    
                    // Close on Escape key
                    const escapeHandler = function(e) {
                        if (e.key === 'Escape') {
                            modal.remove();
                            document.removeEventListener('keydown', escapeHandler);
                        }
                    };
                    document.addEventListener('keydown', escapeHandler);
                } else {
                    showNotification('No debug logs available', 'info');
                }
            } catch (error) {
                console.error('Error loading debug logs:', error);
                showNotification('Failed to load debug logs', 'error');
            }
        }
        
        // Copy logs to clipboard
        function copyLogsToClipboard(logs) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(logs).then(() => {
                    showNotification('Debug logs copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopyLogs(logs);
                });
            } else {
                fallbackCopyLogs(logs);
            }
        }
        
        // Fallback copy method for logs
        function fallbackCopyLogs(logs) {
            const textArea = document.createElement('textarea');
            textArea.value = logs;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            showNotification('Debug logs copied to clipboard!', 'success');
        }
        
        // Show Update Project Location Modal
        function showUpdateLocationModal() {
            const modal = document.getElementById('updateLocationModal');
            const projectSelect = document.getElementById('projectSelect');
            
            // Load projects into dropdown
            loadProjectsForModal();
            
            // Reset form
            resetUpdateLocationForm();
            
            // Add event listener for browse button when modal is shown
            const browseNewLocationBtn = document.getElementById('browseNewLocationBtn');
            if (browseNewLocationBtn) {
                // Remove any existing event listener
                browseNewLocationBtn.removeEventListener('click', browseNewLocation);
                // Add the event listener
                browseNewLocationBtn.addEventListener('click', browseNewLocation);
                console.log('Browse button event listener added');
            } else {
                console.error('Browse button not found');
            }
            
            // Show modal
            modal.style.display = 'block';
        }
        
        // Close Update Project Location Modal
        function closeUpdateLocationModal() {
            document.getElementById('updateLocationModal').style.display = 'none';
            resetUpdateLocationForm();
        }
        
        // Reset Update Location Form
        function resetUpdateLocationForm() {
            document.getElementById('projectSelect').value = '';
            document.getElementById('newLocationPath').value = '';
            document.getElementById('currentLocationInfo').style.display = 'none';
            document.getElementById('newLocationSection').style.display = 'none';
            document.getElementById('applyLocationUpdateBtn').disabled = true;
        }
        
        // Load projects for modal dropdown
        async function loadProjectsForModal() {
            const projectSelect = document.getElementById('projectSelect');
            
            try {
                const response = await fetch('api.php?action=projects');
                const data = await response.json();
                
                if (data.success) {
                    // Clear existing options
                    projectSelect.innerHTML = '<option value="">Select a project...</option>';
                    
                    // Add projects
                    data.data.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.domain;
                        option.textContent = `${project.name} (${project.domain})`;
                        option.dataset.name = project.name;
                        projectSelect.appendChild(option);
                    });
                    
                    // Add event listener for selection change
                    projectSelect.onchange = handleProjectSelectionChange;
                } else {
                    projectSelect.innerHTML = '<option value="">Error loading projects</option>';
                }
            } catch (error) {
                console.error('Error loading projects for modal:', error);
                projectSelect.innerHTML = '<option value="">Error loading projects</option>';
            }
        }
        
        // Handle project selection change
        async function handleProjectSelectionChange() {
            const projectSelect = document.getElementById('projectSelect');
            const currentLocationInfo = document.getElementById('currentLocationInfo');
            const newLocationSection = document.getElementById('newLocationSection');
            const currentLocationPath = document.getElementById('currentLocationPath');
            const applyBtn = document.getElementById('applyLocationUpdateBtn');
            
            if (!projectSelect.value) {
                currentLocationInfo.style.display = 'none';
                newLocationSection.style.display = 'none';
                applyBtn.disabled = true;
                return;
            }
            
            try {
                // Get current project location from vhosts config
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_project_location',
                        domain: projectSelect.value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show current location
                    currentLocationPath.textContent = data.data.documentRoot;
                    currentLocationInfo.style.display = 'block';
                    newLocationSection.style.display = 'block';
                } else {
                    showNotification('Error getting project location: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error getting project location:', error);
                showNotification('Network error getting project location', 'error');
            }
        }
        
        // Set new location path
        function setNewLocationPath(path) {
            document.getElementById('newLocationPath').value = path;
            validateLocationUpdate();
        }
        
        // Browse for new location
        function browseNewLocation() {
            // Set flag to indicate we're browsing for new location
            window.updateLocationBrowseMode = true;
            // Update the modal title to reflect the purpose
            const folderBrowserTitle = document.querySelector('#folderBrowser h3');
            if (folderBrowserTitle) {
                folderBrowserTitle.textContent = 'üìÇ Select New Project Location';
            }
            browseFolder();
        }
        
        // Create separate function for update location selection
        function selectCurrentFolderForUpdate() {
            document.getElementById('newLocationPath').value = currentBrowsePath;
            closeFolderBrowser();
            validateLocationUpdate();
            window.updateLocationBrowseMode = false;
            // Restore original title
            const folderBrowserTitle = document.querySelector('#folderBrowser h3');
            if (folderBrowserTitle) {
                folderBrowserTitle.textContent = 'üìÅ Select Project Folder';
            }
        }
        
        // Override selectCurrentFolder for new location browsing
        const originalSelectCurrentFolder = window.originalSelectCurrentFolder || selectCurrentFolder;
        window.originalSelectCurrentFolder = originalSelectCurrentFolder;
        
        selectCurrentFolder = function() {
            if (window.updateLocationBrowseMode) {
                selectCurrentFolderForUpdate();
            } else {
                originalSelectCurrentFolder();
            }
        };
        
        // Validate location update form
        function validateLocationUpdate() {
            const projectSelect = document.getElementById('projectSelect');
            const newLocationPath = document.getElementById('newLocationPath');
            const applyBtn = document.getElementById('applyLocationUpdateBtn');
            
            const isValid = projectSelect.value && newLocationPath.value.trim();
            applyBtn.disabled = !isValid;
        }
        
        // Apply location update
        async function applyLocationUpdate() {
            const projectSelect = document.getElementById('projectSelect');
            const newLocationPath = document.getElementById('newLocationPath');
            const applyBtn = document.getElementById('applyLocationUpdateBtn');
            
            const selectedProject = projectSelect.value;
            const newPath = newLocationPath.value.trim();
            const projectName = projectSelect.selectedOptions[0]?.dataset?.name || selectedProject;
            
            if (!selectedProject || !newPath) {
                showNotification('Please select a project and enter a new location', 'error');
                return;
            }
            
            // Show loading state
            const originalText = applyBtn.textContent;
            applyBtn.textContent = 'üîÑ Updating...';
            applyBtn.disabled = true;
            
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_project_location',
                        domain: selectedProject,
                        newLocation: newPath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success
                    applyBtn.textContent = '‚úÖ Updated!';
                    applyBtn.style.background = '#28a745';
                    
                    showNotification(`Project location updated successfully!`, 'success');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        closeUpdateLocationModal();
                        
                        // Refresh projects list
                        projectsCache = null;
                        loadProjects();
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Failed to update project location');
                }
            } catch (error) {
                console.error('Error updating project location:', error);
                
                // Show error
                applyBtn.textContent = '‚ùå Update Failed';
                applyBtn.style.background = '#dc3545';
                
                showNotification('Failed to update project location: ' + error.message, 'error');
                
                // Reset button after delay
                setTimeout(() => {
                    applyBtn.textContent = originalText;
                    applyBtn.style.background = '#28a745';
                    applyBtn.disabled = false;
                }, 3000);
            }
        }
        
        // Add input event listener for validation
        document.addEventListener('DOMContentLoaded', function() {
            const newLocationInput = document.getElementById('newLocationPath');
            if (newLocationInput) {
                newLocationInput.addEventListener('input', validateLocationUpdate);
            }
        });
    </script>
</body>
</html>
